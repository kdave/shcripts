#!/bin/sh
## Prettyfier of objdump assembly (AT&T, nice line graphics)

# One-liner:
#objdump --disassembler-options=suffix --insn-width=12 --visualize-jumps=extended-color -dr "$@" | c++filt | less

color='--disassembler-color=extended'
jumps="--visualize-jumps=extended-color"
insns="--insn-width=12"
prefix=""
default=""

while getopts "cijp" arg; do
	case "$arg" in
		h)
			echo "Usage: $0 [-cijp] objectfile"
			exit
			;;
		c) color= ;;
		i) insns="--no-show-raw-insn" ;;
		j) jumps= ;;
		p) prefix="--prefix-addresses" ;;
	esac
done
shift $((OPTIND-1))

# https://symbl.cc/en/unicode/blocks/box-drawing/
# !separation matters, order matters!
objdump "$default" "$color" "$prefix" "$insns" "$jumps" \
	-dr "$@" | c++filt |
	sed -e 's/\s+[\/,]-/â”Œâ”€/' |
	sed -e 's/\s+[\/,]\([^m]*m\)-/â”Œ\1â”€/' |
	sed -e 's/\([^m]*m\),\([^m]*m\)/\1â”Œ\2/' |
	sed -e "s/[\\']/â””/g" |
	sed -e 's/|/â”‚/g' |
	sed -e 's/---/â”€â”€â”€/g' |
	sed -e 's/--/â”€â”€/g' |
	sed -e 's/â”€-/â”€â”€/g' |
	sed -e 's/â”€\([^m]*m\)-/â”€\1â”€/g' |
	sed -e 's/-\([^m]*m\)-/â”€\1â”€/g' |
	sed -e 's/->/â”€>/' |
	sed -e 's/-\([^m]*m\)>/â”€\>/' |
	sed -e 's/[+>]â”€/â”œâ”€/' |
	sed -e 's/[+>]\([^m]*m\)â”€/â”œ\1â”€/' |
	sed -e 's/m,/mY/' |
	less
